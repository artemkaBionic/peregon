machine:
  node:
     version: 7.2.1
  services:
     - docker

general:
  branches:
    only:
      - master

dependencies:
  override:
    - if [ ! -v ENV ] ; then npm install -g gulp bower ; fi
    - if [ ! -v ENV ] ; then gem install sass ; fi
    - if [ ! -v ENV ] ; then npm install ; fi
    - if [ ! -v ENV ] ; then bower install ; fi 
    - if [ ! -v ENV ] ; then gulp build ; fi 
   
test:
  pre:
     - echo "tests"

deployment:
  prod:
    branch: master
    commands:
      # Login to dockerhub
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      # Add customer data. Need to add customer as a script parameter for other clients!
      - chmod +x customer.sh && ./customer.sh
      # If no ENV variable (Git trigger), build docker image and push it as a lab.
      - if [ ! -v ENV ] ; then docker build --rm=false -t basechord/portal . ; fi
      - if [ ! -v ENV ] ; then docker tag basechord/portal basechord/portal:lab && docker push basechord/portal:lab; fi
      - if [ ! -z "$ENV" ]; then chmod +x deploy_pipeline.sh && ./deploy_pipeline.sh ; fi

deployment:
  lab:
    branch: master
    commands:
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      # Add customer data. Need to add customer as a script parameter for other clients!
      - chmod +x customer.sh && ./customer.sh
      - docker build --rm=false -t basechord/portal .
      - docker tag basechord/portal basechord/portal:lab
      - docker push basechord/portal:lab
  canary:
    branch: canary
    commands:
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - docker tag basechord/portal basechord/portal:canary
      - docker push basechord/portal:canary
  canary2:
    branch: canary2
    commands:
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - docker tag basechord/portal basechord/portal:canary2
      - docker push basechord/portal:canary2
  production:
    branch:  production
    commands:
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - docker tag basechord/portal basechord/portal:production
      - docker push basechord/portal:production

